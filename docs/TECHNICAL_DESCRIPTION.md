# Career Copilot — Техническое описание

## 1. Общая архитектура

Career Copilot — веб-приложение для построения персонализированных планов карьерного развития. Система объединяет NLP-нормализацию, семантический поиск через эмбеддинги, gap-анализ по формальной модели и генеративный ИИ для формирования рекомендаций.

### 1.1. Архитектурная схема

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Клиент (браузер)                            │
│  React 19 + TypeScript + Tailwind CSS 4 + Recharts                 │
│                                                                     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│  │ Welcome  │→│ GoalSetup│→│  Skills  │→│ Confirm  │→│  Result  │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │
│                                                        │           │
│                                           ┌────────────▼────────┐  │
│                                           │   Focused Plan UI   │  │
│                                           │  (выбор → генерация)│  │
│                                           └─────────────────────┘  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │ HTTP JSON / multipart
┌──────────────────────────────▼──────────────────────────────────────┐
│                       FastAPI (api.py)                              │
│                                                                     │
│  GET /api/professions          POST /api/plan                       │
│  GET /api/skills-for-role      POST /api/focused-plan               │
│  GET /api/suggest-skills       POST /api/analyze-resume             │
│  GET /health                                                        │
├─────────────────────────────────────────────────────────────────────┤
│                    Слой обработки данных                            │
│                                                                     │
│  ┌────────────────┐  ┌─────────────────┐  ┌──────────────────────┐ │
│  │ skill_         │  │ gap_analyzer    │  │ scenario_handler     │ │
│  │ normalizer     │  │ (семантический  │  │ (next_grade /        │ │
│  │ (лемматизация  │  │  мэтчинг +     │  │  switch / explore)   │ │
│  │  + синонимы)   │  │  gap-расчет)   │  │                      │ │
│  └───────┬────────┘  └───────┬─────────┘  └──────────┬───────────┘ │
│          │                   │                       │             │
│  ┌───────▼───────────────────▼───────────────────────▼───────────┐ │
│  │                    rag_service                                 │ │
│  │  Sentence-Transformers (MiniLM-L12-v2, 384d)                  │ │
│  │  semantic_match_skills() — попарный мэтчинг                   │ │
│  │  compute_profile_similarity() — профильный эмбеддинг           │ │
│  │  retrieve() — векторный поиск по Qdrant                       │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌────────────────┐  ┌─────────────────┐  ┌──────────────────────┐ │
│  │ data_loader    │  │ output_         │  │ plan_generator       │ │
│  │ (JSON → dict)  │  │ formatter       │  │ (GPT-4o)             │ │
│  └────────────────┘  └─────────────────┘  └──────────────────────┘ │
├─────────────────────────────────────────────────────────────────────┤
│                    Внешние сервисы                                  │
│  OpenAI API (GPT-4o)              Qdrant Cloud (векторная БД)      │
├─────────────────────────────────────────────────────────────────────┤
│                    Данные                                           │
│  clean_skills.json (~6900 навыков) │ atlas_params_clean.json (7 п.) │
│  skill_synonyms.json (словарь)    │ skill_clusters.json (кластеры) │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2. Стек технологий

| Слой | Технологии |
|---|---|
| Фронтенд | React 19, TypeScript 5.9, Vite 7, Tailwind CSS 4, Recharts, Lucide React |
| Бэкенд | Python 3.12, FastAPI, Uvicorn, Pydantic v2 |
| NLP | pymorphy3 (лемматизация RU), NLTK Snowball (стемминг EN), Sentence-Transformers |
| Эмбеддинги | paraphrase-multilingual-MiniLM-L12-v2 (384 измерения) |
| Векторная БД | Qdrant Cloud (REST API, косинусная метрика) |
| Генеративный ИИ | OpenAI GPT-4o (temperature 0.3, JSON response format) |
| Инфраструктура | Docker (multi-stage build), Railway |

---

## 2. Пайплайн обработки данных

### 2.1. Полный пайплайн запроса

```
Пользовательский ввод
        │
        ▼
┌─────────────────────┐
│ 1. Нормализация     │  skill_normalizer → resolve_to_canonical()
│    навыков           │  api.py → _skills_table_to_user_skills()
│                      │  0/0.5→Basic(1), 1/1.5→Proficiency(2), 2→Advanced(3)
└──────────┬──────────┘
           ▼
┌─────────────────────┐
│ 2. Инъекция атлас-  │  api.py: atlas params ← GRADE_TO_PARAM_ORDINAL[grade]
│    параметров        │  Младший=1, Специалист=2, Старший=3, Ведущий=4, Эксперт=5
└──────────┬──────────┘
           ▼
┌─────────────────────┐
│ 3. Загрузка         │  scenario_handler → data_loader.get_role_requirements()
│    требований роли   │  Навыки: GRADE_TO_SKILL_LEVEL[target_grade]
│                      │  Параметры: GRADE_TO_PARAM_ORDINAL[target_grade]
└──────────┬──────────┘
           ▼
┌─────────────────────┐
│ 4. Семантический    │  rag_service.semantic_match_skills()
│    мэтчинг           │  Эмбеддинги: encode() → cosine similarity matrix
│                      │   1:1 маппинг, порог ≥ 0.72
└──────────┬──────────┘
           ▼
┌─────────────────────┐
│ 5. Gap-анализ       │  gap_analyzer.analyze_structured()
│                      │  delta = required - current
│                      │  Сортировка по delta ↓
│                      │  match% = strong / total × 100
└──────────┬──────────┘
           ▼
┌─────────────────────┐
│ 6. Формирование     │  output_formatter → markdown
│    диагностики       │  api.py → structured analysis JSON
└──────────┬──────────┘
           ▼
┌─────────────────────┐
│ 7. Генерация плана  │  /api/focused-plan
│    (по выбору)       │  GPT-4o: JSON {tasks, communication, learning}
└─────────────────────┘
```

### 2.2. Нормализация навыков (этап 1)

Пользователь вводит навыки в произвольной форме. Система приводит их к каноническим названиям через три уровня:

**Уровень 1 — Синонимы.** Словарь `skill_synonyms.json` содержит маппинги вида `"питон" → "Python"`, `"управление проектами" → "Управление проектами"`. Проверяются: точное совпадение (lowercase), нормализованное (после лемматизации), побуквенное сравнение лемм.

**Уровень 2 — Лемматизация.** Для русского языка используется pymorphy3 (морфологический анализатор, возвращает нормальную форму). Для английского — NLTK SnowballStemmer. Язык определяется по наличию кириллицы в слове.

**Уровень 3 — Семантический маппинг (RAG).** Если первые два уровня не дали результата, навык передаётся в `rag_service.map_to_canonical_skill()` — векторный поиск по Qdrant с порогом 0.72. Навык маппится на ближайший каноническое название если cosine similarity ≥ порога.

**Конвертация уровней (фронтенд → бэкенд):**

| Фронтенд (0–2) | Внутренний уровень | Описание |
|---|---|---|
| 0, 0.5 | 1 (Basic) | Не использую / Иногда сталкивался |
| 1, 1.5 | 2 (Proficiency) | Уверенно применяю / В сложных ситуациях |
| 2 | 3 (Advanced) | Могу обучать |

### 2.3. Двойная ординальная шкала (этап 2–3)

Система использует две различные шкалы для параметров и навыков:

**Параметры атласа — 5-уровневая шкала:**

| Грейд | Ordinal | Ключ в JSON |
|---|---|---|
| Junior | 1 | Младший |
| Middle | 2 | Специалист |
| Senior | 3 | Старший |
| Lead | 4 | Ведущий |
| Expert | 5 | Эксперт |

Текущий уровень параметра = ordinal текущего грейда пользователя.
Требуемый уровень = ordinal целевого грейда.
Delta = required_ordinal − current_ordinal.

**Навыки — 3-уровневая шкала:**

| Грейд | Требуемый уровень |
|---|---|
| Junior | Basic (1) |
| Middle, Senior | Proficiency (2) |
| Lead, Expert | Advanced (3) |

### 2.4. Семантический мэтчинг (этап 4)

Ключевой алгоритм, решающий проблему несовпадения названий навыков пользователя и требований роли.

**Алгоритм `semantic_match_skills()`:**

```
Вход: user_skill_names[N], required_skill_names[M]

1. Генерация эмбеддингов:
   user_vecs = encode(user_skill_names)      → [N × 384]
   req_vecs  = encode(required_skill_names)   → [M × 384]

2. Матрица косинусной близости:
   sim_matrix = dot(user_vecs, req_vecs.T)    → [N × M]

3. Отбор пар с score ≥ threshold (0.72):
   pairs = [(score, i, j) for score ≥ 0.72]
   pairs.sort(descending by score)

4. Жадное назначение 1:1:
   for (score, i, j) in pairs:
     if user[i] не назначен AND required[j] не назначен:
       result[user[i]] = required[j]

Выход: {user_name → matched_required_name}
```

**Примеры мэтчинга:**
- `SQL` → `Написание SQL-запросов` (score 0.83)
- `Agile` → `Agile/Scrum` (score 0.87)
- `Аналитика данных` → `Работа с данными` (score 0.79)

**Модель эмбеддингов:** `paraphrase-multilingual-MiniLM-L12-v2` — мультиязычная модель (50+ языков), 384 измерения, L2-нормализация для cosine similarity.

### 2.5. Profile Embedding (для сценария Explore)

Для быстрого сравнения профиля пользователя с профилями ролей используется средний эмбеддинг:

```
user_profile_vec  = mean(encode(user_skill_names))  → normalize
role_profile_vec  = mean(encode(role_skill_names))   → normalize
similarity = dot(user_profile_vec, role_profile_vec)  → [0..1]
```

Используется в `scenario_handler.explore_opportunities()` для ранжирования ролей по семантической близости. Результат сортируется по `semantic_score` (profile similarity) → `match%` (точное пересечение).

### 2.6. Gap-анализ (этап 5)

**Алгоритм `analyze_structured()`:**

```
Для каждого требования роли:
  1. Определить тип: параметр атласа или навык
  2. Найти текущий уровень пользователя:
     - Точное совпадение имени
     - Семантическое совпадение (через semantic_match_skills)
     - Если не найден → 0
  3. Вычислить delta = required − current
  4. Классифицировать:
     - delta ≤ 0 → Strong (навык освоен)
     - delta > 0 → Gap (разрыв)
  5. Приоритизировать gap:
     - delta ≥ 2 → Priority 1 (критический)
     - delta ≥ 1 → Priority 2 (умеренный)
     - delta < 1 → Priority 3 (минимальный)

match% = |strong| / |total_requirements| × 100
```

### 2.7. Генерация плана (этап 7)

Двухэтапная генерация:

**Этап 1 — Диагностический отчёт.** Формируется в `output_formatter.py`: markdown с таблицами gap-анализа, описаниями навыков из JSON, ожиданиями по параметрам. Передаётся фронтенду в поле `markdown`.

**Этап 2 — План развития.** Генерируется через `POST /api/focused-plan` после того, как пользователь выбрал конкретные навыки для развития.

**Архитектура промпта `/api/focused-plan`:**

```
┌─────────────────────────────────────┐
│ System: JSON-only response mode     │
├─────────────────────────────────────┤
│ User prompt:                        │
│                                     │
│ 1. Выбранные навыки: [список]       │
│ 2. Контекст: профессия, грейд, цель│
│ 3. Данные из JSON для каждого       │
│    навыка:                          │
│    - Описание целевого уровня       │
│    - Примеры задач на развитие      │
│                                     │
│ Требуемый формат ответа:            │
│ {                                   │
│   tasks: [{skill, items[]}],        │
│   communication: [string],          │
│   learning: [string]                │
│ }                                   │
└─────────────────────────────────────┘
```

**Параметры генерации:**
- Модель: GPT-4o
- Temperature: 0.3 (низкая вариативность)
- Max tokens: 2000 (для focused-plan), 4096 (для full plan)
- Response format: `json_object`
- Retry: 3 попытки с задержкой

---

## 3. Структура данных

### 3.1. clean_skills.json

~6900 записей. Каждая запись:

| Поле | Описание |
|---|---|
| `Навык` | Каноническое название |
| `Профессия (лист)` | Внутреннее название скиллсета (привязка к профессии) |
| `Категория` | Тематическая группа (ML & Data, Инструменты, и т.д.) |
| `Свойства` | Тип навыка |
| `Skill level \\ Индикатор - Basic` | Описание поведения на уровне Basic |
| `Skill level \\ Индикатор - Proficiency` | Описание поведения на уровне Proficiency |
| `Skill level \\ Индикатор - Advanced` | Описание поведения на уровне Advanced |
| `Пример задач на развитие \\ уровень Basic` | Конкретные задачи для прокачки до Basic |
| `Пример задач на развитие \\ уровень Proficiency` | Задачи для Proficiency |
| `Пример задач на развитие \\ уровень Advanced` | Задачи для Advanced |

### 3.2. atlas_params_clean.json

7 параметров карьерного роста:

| Поле | Описание |
|---|---|
| `Параметр` | Название (Автономность, Масштаб влияния и т.д.) |
| `Описание` | Общее описание параметра |
| `Младший` ... `Эксперт` | Текстовые ожидания для каждого грейда |

### 3.3. skill_synonyms.json

Словарь `{синоним: каноническое_название}`. Примеры: `"питон" → "Python"`, `"управление проектами" → "Управление проектами"`.

---

## 4. API

### 4.1. Основные эндпоинты

| Метод | Путь | Назначение |
|---|---|---|
| `GET` | `/api/professions` | Список профессий |
| `GET` | `/api/skills-for-role?profession=...` | Навыки для профессии |
| `GET` | `/api/suggest-skills?q=...` | Подсказки навыков (RAG + синонимы) |
| `POST` | `/api/analyze-resume` | PDF → извлечение навыков через GPT-4o |
| `POST` | `/api/plan` | Gap-анализ + диагностика + structured analysis |
| `POST` | `/api/focused-plan` | Фокусный план по выбранным навыкам |
| `GET` | `/health` | Проверка состояния |

### 4.2. POST /api/plan — основной эндпоинт

**Запрос:**
```json
{
  "profession": "Менеджер продукта",
  "grade": "Специалист (Middle)",
  "skills": [{"name": "SQL", "level": 1.5}],
  "scenario": "Следующий грейд",
  "target_profession": null
}
```

**Ответ:**
```json
{
  "markdown": "# Цель: Перейти на следующий грейд\n...",
  "analysis": {
    "scenario": "growth",
    "current_grade": "Middle",
    "target_grade": "Senior",
    "match_percent": 42,
    "radar_data": [
      {"param": "Автономность", "current": 2, "target": 3,
       "current_label": "Специалист", "target_label": "Старший"}
    ],
    "skill_gaps": [
      {"name": "System Design", "current": 0, "required": 2, "delta": 2,
       "level_key": "Proficiency", "description": "...", "tasks": "..."}
    ],
    "skill_strong": [{"name": "SQL", "level": 2}]
  }
}
```

### 4.3. POST /api/focused-plan

**Запрос:**
```json
{
  "profession": "Менеджер продукта",
  "grade": "Специалист (Middle)",
  "scenario": "Следующий грейд",
  "selected_skills": ["System Design", "Roadmap"]
}
```

**Ответ:**
```json
{
  "tasks": [
    {"skill": "System Design", "items": ["Спроектировать API для нового сервиса", "Провести ревью архитектуры"]}
  ],
  "communication": ["Найти ментора по архитектуре", "Участвовать в design review"],
  "learning": ["Книга: 'Designing Data-Intensive Applications'"]
}
```

---

## 5. Три сценария

### 5.1. Следующий грейд (Growth)

Определяет целевой грейд как следующий в последовательности Junior→Middle→Senior→Lead→Expert. Загружает требования целевого грейда, выполняет gap-анализ, формирует radar chart по параметрам атласа.

### 5.2. Смена профессии (Switch)

Загружает требования целевой роли на baseline-уровне (на один грейд ниже целевого). Выполняет gap-анализ с семантическим мэтчингом. Разделяет навыки на переносимые (transferable) и недостающие (gaps). Использует кластеризацию навыков (KMeans) для формирования рекомендуемых треков.

### 5.3. Исследование возможностей (Explore)

Перебирает все роли на грейдах Junior/Middle/Senior. Для каждой считает: точное пересечение + семантический мэтчинг + profile embedding similarity. Дедуплицирует и категоризирует: ближайшие (≥15%), смежные (5–15%), дальние (<5%).

---

## 6. Фронтенд (реализован с помощью Cursor)

### 6.1. Экранный поток

```
Welcome → GoalSetup → Skills → Confirmation → Result
                                                  │
                                          ┌───────▼────────┐
                                          │ Выбор gap-ов   │
                                          │ (чекбоксы)     │
                                          └───────┬────────┘
                                                  │
                                          ┌───────▼────────┐
                                          │ Focused Plan   │
                                          │ (3 секции)     │
                                          └────────────────┘
```

### 6.2. Визуализация результатов

**Growth:** Radar chart (Recharts) для 7 параметров атласа, прогресс-бары для зон развития, аккордеон с описаниями навыков.

**Switch:** Карточка сравнения "из → в" с процентом совместимости, чипсы переносимых навыков и зон роста.

**Explore:** Сетка карточек ролей с цветовой категорией и процентом совпадения.

### 6.3. Темизация

CSS Custom Properties с двумя наборами значений (`:root` / `.dark`). Переключение через `ThemeProvider` с сохранением в `localStorage`. Inline-скрипт в `index.html` предотвращает вспышку при загрузке.

---

## 7. Деплой (Реализован через railways)

Multi-stage Dockerfile:
- Stage 1 (Node.js 20): `npm ci` + `npm run build` → `frontend/dist`
- Stage 2 (Python 3.12): `pip install` + копирование + `python api.py`

FastAPI раздаёт статику из `frontend/dist` через catch-all маршрут. Один контейнер, один URL.

---

## 8. Конфигурация

| Переменная | Значение | Описание |
|---|---|---|
| `OPENAI_API_KEY` | — | Ключ OpenAI (обязателен для AI-генерации) |
| `QDRANT_URL` | — | URL Qdrant Cloud |
| `QDRANT_API_KEY` | — | API-ключ Qdrant |
| `SKILL_MAP_SIMILARITY_THRESHOLD` | 0.72 | Порог маппинга навыка → канонический |
| `SKILL_MATCH_THRESHOLD` | 0.72 | Порог семантического мэтчинга при gap-анализе |
| `RAG_SCORE_THRESHOLD` | 0.35 | Порог релевантности при RAG-поиске |
| `EXPLORE_CLOSEST_MIN` | 0.15 | Порог категории "ближайшие" (≥15%) |
| `EXPLORE_ADJACENT_MIN` | 0.05 | Порог категории "смежные" (≥5%) |

---

## 9. Метрики качества обработки данных (Следующие шаги)

Для объективной оценки качества каждого этапа пайплайна определена система метрик, реализация которых запланирована в следующих итерациях продукта.

### 9.1. Метрики нормализации навыков

| Метрика | Определение | Целевое значение |
|---|---|---|
| **Recall нормализации** | Доля пользовательских навыков, для которых найдено каноническое соответствие (через синонимы, лемматизацию или RAG) | ≥ 80% |
| **Precision нормализации** | Доля корректных маппингов среди всех выполненных (оценивается на размеченной выборке из 100–200 пар) | ≥ 90% |

### 9.2. Метрики RAG-поиска (Retrieval)

| Метрика | Определение | Целевое значение |
|---|---|---|
| **Coverage индекса** | `кол-во точек в Qdrant / кол-во навыков в JSON × 100%` — полнота индексации | ≥ 95% |
| **Precision@K** | Доля релевантных результатов среди K возвращённых (для подсказок навыков и RAG-контекста) | ≥ 75% при K=5 |
| **Recall@K** | Доля найденных релевантных навыков из всех релевантных в базе | ≥ 60% при K=5 |
| **MRR (Mean Reciprocal Rank)** | Средняя обратная позиция первого релевантного результата | ≥ 0.7 |
| **Empty result rate** | Доля запросов, для которых RAG возвращает 0 результатов | ≤ 15% |
| **Score distribution** | Средняя cosine similarity по возвращённым результатам | ≥ 0.55 |

### 9.3. Метрики семантического мэтчинга навыков

| Метрика | Определение | Целевое значение |
|---|---|---|
| **Precision мэтчинга** | Доля корректных семантических пар (ручная оценка на 50–100 парах) | ≥ 85% |
| **Recall мэтчинга** | Доля навыков пользователя, которые нашли корректную пару среди требований роли | ≥ 70% |
| **F1-score** | Гармоническое среднее precision и recall | ≥ 0.77 |
| **Threshold sensitivity** | Кривая precision/recall при варьировании порога 0.60–0.85; оптимум — максимум F1 | — |
| **Match rate** | `кол-во matched пар / кол-во навыков пользователя × 100%` | ≥ 50% |
| **Средний score пар** | Средняя cosine similarity по matched парам (уверенность мэтчинга) | ≥ 0.78 |

### 9.4. Метрики RAG-контекста для LLM

| Метрика | Определение | Целевое значение |
|---|---|---|
| **Context relevance** | Доля чанков в контексте, относящихся к gap-навыкам пользователя | ≥ 70% |
| **Context utilization** | Доля чанков, информация из которых использована LLM в итоговом плане | ≥ 50% |
| **Faithfulness** | Доля утверждений в плане, подтверждаемых данными из контекста (не галлюцинации) | ≥ 85% |
| **Context size** | Количество токенов в RAG-контексте | 500–2500 токенов |

### 9.5. Метрики генерации плана (AI)

| Метрика | Определение | Целевое значение |
|---|---|---|
| **Completeness** | `навыков в ответе / выбранных навыков × 100%` — все ли выбранные навыки получили рекомендации | 100% |
| **Hallucination rate** | Доля рекомендаций, не основанных на данных из контекста | ≤ 10% |
| **Средняя длина ответа** | Количество токенов в сгенерированном плане | 400–1500 токенов |

### 9.6. Метрики сценария Explore

| Метрика | Определение | Целевое значение |
|---|---|---|
| **Profile similarity distribution** | Разброс cosine similarity между профилем пользователя и профилями ролей | std ≥ 0.15 |
| **Top-3 relevance** | Ручная оценка: доля случаев, когда первые 3 роли действительно ближайшие к профилю | ≥ 80% |
| **Semantic vs exact agreement** | Корреляция между семантическим score и точным match% | r ≥ 0.5 |

### 9.7. План реализации мониторинга

Реализация системы метрик запланирована в два этапа:

**Этап 1 — Автоматическое логирование (ближайшая итерация).** Добавление структурированных логов в ключевые функции пайплайна: `_skills_table_to_user_skills`, `semantic_match_skills`, `analyze_structured`, `focused_plan_api`. Метрики: match rate, empty result rate, score distribution, completeness, JSON validity. Логи агрегируются и визуализируются на дашборде.

**Этап 2 — Ручная оценка ** Разметка 30–50 эталонных кейсов: профиль пользователя → ожидаемые gap-навыки → ожидаемые matched пары → ожидаемые роли в Explore. Сравнение выхода системы с эталоном для расчёта precision, recall, F1, faithfulness. Определение оптимального порога семантического мэтчинга через кривую precision-recall.
